<%# app/views/setup/products/index.html.erb %>
<% content_for :title, "Products" %>
<% content_for :breadcrumb do %>
  <span style="color:var(--text-dim)">Setup</span>
  <span class="breadcrumb-sep">/</span>
  <span class="breadcrumb-current">Products</span>
<% end %>

<%= render 'setup/shared/master_styles' %>

<div class="page-header">
  <div>
    <div class="page-title">Master Data</div>
    <div class="page-subtitle"></div>
  </div>
  <%= link_to new_setup_product_path, class: 'btn btn-primary' do %>
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    New Product
  <% end %>
</div>

<%= render 'setup/shared/nav_tabs' %>

<!-- Filters -->
<div class="filter-bar" style="flex-wrap:wrap">
  <div class="search-input-wrap">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input type="text" class="search-input"
           placeholder="Search brand, description, code..." id="productSearch">
  </div>

  <%= form_with url: setup_products_path, method: :get, local: true,
        style: 'display:flex;gap:8px;align-items:center' do |f| %>
    <%= f.select :category_id,
          options_from_collection_for_select(@categories, :id, :name, params[:category_id]),
          { include_blank: 'All Categories' },
          style: "background:var(--surface);border:1px solid var(--border);border-radius:6px;
                  padding:8px 12px;color:var(--text);font-size:13px;outline:none" %>
    <%= f.select :status,
          [['All Statuses', ''], ['Active', 'active'], ['Inactive', 'inactive']],
          { selected: params[:status] },
          style: "background:var(--surface);border:1px solid var(--border);border-radius:6px;
                  padding:8px 12px;color:var(--text);font-size:13px;outline:none" %>
    <%= f.submit 'Filter', class: 'btn btn-secondary btn-sm' %>
    <% if params[:category_id].present? || params[:status].present? %>
      <%= link_to 'Clear', setup_products_path, class: 'btn btn-secondary btn-sm' %>
    <% end %>
  <% end %>
</div>

<% if @selected_category %>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;
              font-size:13px;color:var(--text-dim)">
    Filtering by category:
    <span class="badge badge-plan"><%= @selected_category.name %></span>
  </div>
<% end %>

<div class="table-wrap">
  <% if @products.any? %>
    <table id="productTable">
      <thead>
        <tr>
          <th>#</th><th>Brand & Description</th><th>Category</th>
          <th>Codes</th><th>Pack</th><th>HSN</th>
          <th>GST</th><th>UOM</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @products.each do |product| %>
        <tr>
          <td style="font-family:var(--mono);color:var(--text-dim);font-size:12px">
            <%= product.id %>
          </td>
          <td style="max-width:220px">
            <div style="font-weight:500"><%= product.brand %></div>
            <div style="font-size:12px;color:var(--text-dim);margin-top:2px;line-height:1.4">
              <%= link_to product.description.truncate(60), setup_product_path(product),
                    style: 'color:inherit;text-decoration:none' %>
            </div>
          </td>
          <td>
            <span class="badge badge-plan" style="font-size:10px">
              <%= product.product_category.name %>
            </span>
          </td>
          <td style="font-family:var(--mono);font-size:11px;color:var(--text-dim)">
            <% if product.material_code.present? %>
              <div>M: <%= product.material_code %></div>
            <% end %>
            <% if product.product_code.present? %>
              <div>P: <%= product.product_code %></div>
            <% end %>
            <% if product.material_code.blank? && product.product_code.blank? %>
              —
            <% end %>
          </td>
          <td style="font-family:var(--mono);font-size:12px">
            <%= product.pack_code.presence || '—' %>
          </td>
          <td style="font-family:var(--mono);font-size:12px;color:var(--text-dim)">
            <%= product.hsn_code.presence || '—' %>
          </td>
          <td>
            <span style="font-family:var(--mono);font-size:12px;
                         background:<%= product.gst_rate == 0 ? 'rgba(52,217,139,0.1)' : 'rgba(247,195,79,0.1)' %>;
                         color:<%= product.gst_rate == 0 ? 'var(--success)' : 'var(--warning)' %>;
                         padding:2px 6px;border-radius:4px">
              <%= product.gst_rate %>%
            </span>
          </td>
          <td>
            <span style="font-family:var(--mono);font-size:11px;background:var(--bg);
                         border:1px solid var(--border);padding:2px 6px;border-radius:4px">
              <%= product.base_uom.short_name %>
            </span>
          </td>
          <td>
            <span class="badge <%= product.active? ? 'badge-active' : 'badge-inactive' %>">
              <%= product.active? ? 'active' : 'inactive' %>
            </span>
          </td>
          <td>
            <div class="actions">
              <%= link_to 'View', setup_product_path(product), class: 'btn btn-secondary btn-sm' %>
              <%= link_to 'Edit', edit_setup_product_path(product), class: 'btn btn-secondary btn-sm' %>
            </div>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="empty-state">
      <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1"
           viewBox="0 0 24 24" style="color:var(--muted);margin:0 auto 12px;display:block">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
      </svg>
      <p>No products found<%= @selected_category ? " in #{@selected_category.name}" : '' %>.</p>
      <div style="margin-top:16px">
        <%= link_to 'Add first product', new_setup_product_path, class: 'btn btn-primary' %>
      </div>
    </div>
  <% end %>
</div>

<script>
  document.getElementById('productSearch').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#productTable tbody tr').forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
</script>
