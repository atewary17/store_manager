<% content_for :title, "Edit User" %>
<% content_for :breadcrumb do %>
  <%= link_to 'Organisations', organisations_path %>
  <span class="breadcrumb-sep">/</span>
  <%= link_to @organisation.name, organisation_path(@organisation) %>
  <span class="breadcrumb-sep">/</span>
  <%= link_to 'Users', organisation_users_path(@organisation) %>
  <span class="breadcrumb-sep">/</span>
  <%= link_to @user.email.split('@').first, organisation_user_path(@organisation, @user) %>
  <span class="breadcrumb-sep">/</span>
  <span class="breadcrumb-current">Edit</span>
<% end %>

<div class="page-header">
  <div>
    <div class="page-title">Edit User</div>
    <div class="page-subtitle">
      Updating <strong style="color:var(--text)"><%= @user.email %></strong>
    </div>
  </div>
</div>

<%= form_with model: [@organisation, @user], local: true do |f| %>
  <div class="form-card">
    <%= render 'form', user: @user, f: f %>
    <div class="form-actions">
      <%= f.submit 'Save Changes', class: 'btn btn-primary' %>
      <%= link_to 'Cancel', organisation_user_path(@organisation, @user), class: 'btn btn-secondary' %>
    </div>
  </div>
<% end %>

<!-- Danger Zone -->
<div style="margin-top:24px;max-width:680px">
  <div style="border:1px solid rgba(247,97,79,0.25);border-radius:10px;padding:20px;
              background:rgba(247,97,79,0.04)">
    <div style="font-family:var(--mono);font-size:11px;letter-spacing:0.1em;
                text-transform:uppercase;color:var(--danger);margin-bottom:14px">
      Danger Zone
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;
                padding-bottom:14px;border-bottom:1px solid rgba(247,97,79,0.12);margin-bottom:14px">
      <div>
        <div style="font-size:13.5px;font-weight:500">
          <%= @user.active? ? 'Deactivate this account' : 'Reactivate this account' %>
        </div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:3px">
          <%= @user.active? ? 'The user will no longer be able to sign in' : 'Restore access for this user' %>
        </div>
      </div>

      <% if @user == current_user %>
        <span style="font-size:12px;color:var(--text-dim);font-family:var(--mono)">
          Cannot modify yourself
        </span>
      <% else %>
        <%# Toggle status by submitting a quick form %>
        <%= form_with url: organisation_user_path(@organisation, @user),
              method: :patch, local: true, style: 'margin:0' do |sf| %>
          <%= sf.hidden_field :user, value: '' %>
          <%= hidden_field_tag 'user[status]', @user.active? ? 'inactive' : 'active' %>
          <%= hidden_field_tag 'user[role]',   @user.role %>
          <%= hidden_field_tag 'user[email]',  @user.email %>
          <%= sf.submit @user.active? ? 'Deactivate' : 'Reactivate',
                class: "btn btn-danger btn-sm",
                data: { confirm: "Are you sure?" } %>
        <% end %>
      <% end %>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:13.5px;font-weight:500">Reset password</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:3px">
          Send a password reset link to this user's email
        </div>
      </div>
      <%= link_to 'Send Reset Email',
            new_user_password_path,
            class: 'btn btn-danger btn-sm' %>
    </div>
  </div>
</div>
