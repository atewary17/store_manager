<% content_for :title, @organisation.name %>
<% content_for :breadcrumb do %>
  <%= link_to 'Organisations', organisations_path %>
  <span class="breadcrumb-sep">/</span>
  <span class="breadcrumb-current"><%= @organisation.name %></span>
<% end %>

<div class="page-header">
  <div>
    <div class="page-title"><%= @organisation.name %></div>
    <div class="page-subtitle">Organisation details and members</div>
  </div>
  <div class="actions">
    <%= link_to 'Edit Organisation', edit_organisation_path(@organisation), class: 'btn btn-secondary' %>
  </div>
</div>

<!-- Organisation Details Card -->
<div class="detail-card" style="margin-bottom:24px">
  <div class="detail-section">
    <div class="detail-section-title">General Information</div>
    <div class="detail-grid">
      <div class="detail-field">
        <label>Organisation Name</label>
        <div class="value"><%= @organisation.name %></div>
      </div>
      <div class="detail-field">
        <label>GST Number</label>
        <div class="value mono"><%= @organisation.gst_number.presence || '—' %></div>
      </div>
      <div class="detail-field">
        <label>Subscription Plan</label>
        <div class="value">
          <span class="badge badge-plan"><%= @organisation.subscription_plan.presence || 'basic' %></span>
        </div>
      </div>
      <div class="detail-field">
        <label>Status</label>
        <div class="value">
          <span class="badge <%= @organisation.active? ? 'badge-active' : 'badge-inactive' %>">
            <%= @organisation.status %>
          </span>
        </div>
      </div>
      <div class="detail-field" style="grid-column: span 2">
        <label>Address</label>
        <div class="value"><%= @organisation.address.presence || '—' %></div>
      </div>
    </div>
  </div>

  <div class="detail-section">
    <div class="detail-section-title">Record Info</div>
    <div class="detail-grid">
      <div class="detail-field">
        <label>Organisation ID</label>
        <div class="value mono">#<%= @organisation.id %></div>
      </div>
      <div class="detail-field">
        <label>Created At</label>
        <div class="value mono"><%= @organisation.created_at.strftime('%d %b %Y, %H:%M') %></div>
      </div>
      <div class="detail-field">
        <label>Last Updated</label>
        <div class="value mono"><%= @organisation.updated_at.strftime('%d %b %Y, %H:%M') %></div>
      </div>
      <div class="detail-field">
        <label>Total Members</label>
        <div class="value"><%= @users.count %> users</div>
      </div>
    </div>
  </div>
</div>

<!-- Users Section Header -->
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
  <div style="font-size:15px;font-weight:600">
    Members
    <span style="font-family:var(--mono);font-size:12px;color:var(--text-dim);font-weight:400;margin-left:8px">
      <%= @users.count %>
    </span>
  </div>
  <div class="actions">
    <%= link_to organisation_users_path(@organisation), class: 'btn btn-secondary btn-sm' do %>
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      View All Users
    <% end %>
    <% if current_user.super_admin? || current_user.owner? || current_user.admin? %>
      <%= link_to new_organisation_user_path(@organisation), class: 'btn btn-primary btn-sm' do %>
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add User
      <% end %>
    <% end %>
  </div>
</div>

<!-- Quick Search -->
<% if @users.any? %>
  <div class="filter-bar" style="margin-bottom:14px">
    <div class="search-input-wrap">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input type="text" class="search-input" placeholder="Search members..." id="memberSearch">
    </div>
    <select id="memberRoleFilter" style="background:var(--surface);border:1px solid var(--border);
            border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;outline:none">
      <option value="">All Roles</option>
      <option value="super_admin">Super Admin</option>
      <option value="owner">Owner</option>
      <option value="admin">Admin</option>
      <option value="staff">Staff</option>
    </select>
    <select id="memberStatusFilter" style="background:var(--surface);border:1px solid var(--border);
            border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;outline:none">
      <option value="">All Statuses</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>
<% end %>

<!-- Users Table -->
<div class="table-wrap">
  <% if @users.any? %>
    <table id="membersTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Role</th>
          <th>Status</th>
          <th>Joined</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
        <tr>
          <td style="font-family:var(--mono);color:var(--text-dim);font-size:12px">
            <%= user.id %>
          </td>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:30px;height:30px;border-radius:50%;background:var(--accent-dim);
                          color:var(--accent);display:flex;align-items:center;justify-content:center;
                          font-family:var(--mono);font-size:11px;font-weight:500;flex-shrink:0">
                <%= user.initials %>
              </div>
              <div>
                <%= link_to user.full_name, organisation_user_path(@organisation, user) %>
                <% if user == current_user %>
                  <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-left:4px">(you)</span>
                <% end %>
              </div>
            </div>
          </td>
          <td style="font-size:13px;color:var(--text-dim)"><%= user.email %></td>
          <td style="font-family:var(--mono);font-size:12px;color:var(--text-dim)">
            <%= user.phone_number.presence || '—' %>
          </td>
          <td>
            <span class="badge badge-role" data-role="<%= user.role %>">
              <%= user.role.humanize %>
            </span>
          </td>
          <td>
            <span class="badge <%= user.active? ? 'badge-active' : 'badge-inactive' %>"
                  data-status="<%= user.status %>">
              <%= user.status %>
            </span>
          </td>
          <td style="color:var(--text-dim);font-size:12px;font-family:var(--mono)">
            <%= user.created_at.strftime('%d %b %Y') %>
          </td>
          <td>
            <div class="actions">
              <%= link_to 'View', organisation_user_path(@organisation, user), class: 'btn btn-secondary btn-sm' %>
              <% if current_user.super_admin? || current_user.owner? || current_user.admin? %>
                <%= link_to 'Edit', edit_organisation_user_path(@organisation, user), class: 'btn btn-secondary btn-sm' %>
              <% end %>
            </div>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="empty-state">
      <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1"
           viewBox="0 0 24 24" style="color:var(--muted);margin:0 auto 12px;display:block">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <p>No members yet.</p>
      <% if current_user.super_admin? || current_user.owner? || current_user.admin? %>
        <div style="margin-top:16px">
          <%= link_to '+ Add first user', new_organisation_user_path(@organisation), class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div style="margin-top:20px">
  <%= link_to '← Back to Organisations', organisations_path, class: 'btn btn-secondary' %>
</div>

<script>
  function filterMembers() {
    const q      = document.getElementById('memberSearch').value.toLowerCase();
    const role   = document.getElementById('memberRoleFilter').value;
    const status = document.getElementById('memberStatusFilter').value;

    document.querySelectorAll('#membersTable tbody tr').forEach(row => {
      const text      = row.textContent.toLowerCase();
      const rowRole   = row.querySelector('[data-role]')?.dataset.role   || '';
      const rowStatus = row.querySelector('[data-status]')?.dataset.status || '';

      const matchQ      = !q      || text.includes(q);
      const matchRole   = !role   || rowRole   === role;
      const matchStatus = !status || rowStatus === status;

      row.style.display = matchQ && matchRole && matchStatus ? '' : 'none';
    });
  }

  document.getElementById('memberSearch')?.addEventListener('input',  filterMembers);
  document.getElementById('memberRoleFilter')?.addEventListener('change', filterMembers);
  document.getElementById('memberStatusFilter')?.addEventListener('change', filterMembers);
</script>
